# 使用通用视图

在 Django 中，通用视图系统简化了常见模式的处理，使得你不需要编写大量的代码来创建应用。通用视图可以处理常见的需求，例如显示对象列表或显示特定类型对象的详细页面。

## 为什么要重构代码？

通常情况下，编写 Django 应用时，应该首先考虑是否可以使用通用视图来解决问题。最好在开始时就使用它，而不是在开发过程中进行代码重构。本教程目前侧重于以“艰难的方式”编写视图，这是为了侧重核心概念。

## 改良 URLconf

首先，我们需要修改 URLconf，以适应通用视图的使用。打开 `polls/urls.py` 文件并修改为：

```python
from django.urls import path
from . import views

app_name = "polls"
urlpatterns = [
    path("", views.IndexView.as_view(), name="index"),
    path("<int:pk>/", views.DetailView.as_view(), name="detail"),
    path("<int:pk>/results/", views.ResultsView.as_view(), name="results"),
    path("<int:question_id>/vote/", views.vote, name="vote"),
]
```

注意，这里使用了 `<pk>` 替代了之前的 `<question_id>`，因为我们将使用 DetailView 通用视图，它期望从 URL 中捕获的主键值被称为 "pk"。

## 改良视图

接下来，我们将删除旧的 `index`、`detail` 和 `results` 视图，并用 Django 的通用视图来替代。打开 `polls/views.py` 文件并修改为：

```python
from django.http import HttpResponseRedirect
from django.shortcuts import get_object_or_404, render
from django.urls import reverse
from django.views import generic
from .models import Choice, Question

class IndexView(generic.ListView):
    template_name = "polls/index.html"
    context_object_name = "latest_question_list"

    def get_queryset(self):
        """Return the last five published questions."""
        return Question.objects.order_by("-pub_date")[:5]

class DetailView(generic.DetailView):
    model = Question
    template_name = "polls/detail.html"

class ResultsView(generic.DetailView):
    model = Question
    template_name = "polls/results.html"

def vote(request, question_id):
    # same as above, no changes needed.
    ...
```

通用视图需要知道要操作的模型。我们可以使用 `model` 属性提供这个信息，也可以通过定义 `get_queryset()` 方法来实现。

默认情况下，`DetailView` 使用一个叫做 `<app name>/<model name>_detail.html` 的模板。我们也为 `results` 列表视图指定了模板 —— 这确保 `results` 视图和 `detail` 视图在渲染时具有不同的外观，即使它们在后台都是同一个 `DetailView`。

在之前的教程中，提供模板文件时都带有一个包含 `question` 和 `latest_question_list` 变量的上下文。对于 `DetailView`，`question` 变量会自动提供；而对于 `ListView`，自动生成的上下文变量是 `question_list`。为了覆盖这个行为，我们提供了 `context_object_name` 属性，指定了我们想使用的变量名。

启动服务器，尝试使用基于通用视图的新投票应用。

## 更多信息

当你对所写的表单和通用视图感到满意后，请阅读教程的第 5 部分，了解如何测试我们的投票应用。更多关于通用视图的详细信息，请查看[通用视图文档](https://docs.djangoproject.com/en/3.2/topics/class-based-views/)。